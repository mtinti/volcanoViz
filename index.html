<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>VolcanoViz</title>
  <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tour/0.12.0/css/bootstrap-tour-standalone.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.6.2/css/buttons.dataTables.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tour/0.12.0/css/bootstrap-tour.css">
  <link rel="stylesheet" type="text/css" href="app.css">
</head>

<body>

  <main role="main">

  <div class="container">
    <div class="row">
    </div>



    <div class="row">
        <div class="col-md-2">
        </div>

        <div class="col-md-8">
          <img class="img-responsive" style="width: 100%" 
          id="theImg" src="uod-wcair-full.png" />
        </div>
        
        <div class="col-md-2">
        </div>

      </div>  
    

    <div class="row">
      <div class="col-md-6">
        <svg id="plot2"></svg>
      </div>
      <div class="col-md-6">
        <svg id="plot1"></svg>
      </div>
    </div>

    <div class="row">

      <div class="col-md-8">

        <table id='table' class="display compact"></table>

      </div>

      <div class="col-md-4">

        <div class="d-flex flex-row">
          
          <div class="col-md-1">
          </div>

        <div class="col-md-8">
          <form id="my-form">
              <div class="form-outline">
                <textarea class="form-control" id="textAreaIDs" rows="8" style="font-size:12px;"></textarea>
                <label class="form-label" for="textAreaIDs">Select Multiple IDs</label>
                <br>
                <button type="submit" class="btn btn-primary" >Submit</button>
                <button type="reset" class="btn btn-primary" >Reset</button>
              </div>
          </form>
       </div>

        <div class="col-md-3">

        </div>
        </div>


      </div>

    </div>

      
      


  </div>
</main>
      


  
  <style>


  </style>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tour/0.12.0/js/bootstrap-tour-standalone.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.2/js/dataTables.buttons.min.js"></script> 
  <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.html5.min.js"></script> 
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tour/0.12.0/js/bootstrap-tour.js"></script> 
  <script src="https://d3js.org/d3.v5.js"></script>
  <script src="extend_domain.js"></script>
  <script src="drag_element.js"></script>  
  <script src="app.js"></script>
  <script src="tour.js"></script> 
  <script src="https://d3js.org/d3-drag.v2.min.js"></script>
  
  <script>

    

    var tooltip = d3.select('body').append('div').attr('id', 'tooltip');

    //select the columns to plot
    let X1='logFC';
    let Y1='log_PValue';
    let X2='logCPM';
    let Y2='logFC'; 

    Promise.all([d3.csv('indata.csv')]).then(function(files) {
      
      //use all the columns in the file
      var columns = files[0].columns;
      console.log('File Columns', columns);
      //add data to the table
      tabulate(files[0], columns, '#table');

      //we expect to have 3 fix columns:
      //Gene_acc -> a unique integer identifiers, hidden in the 
      //datatable but used for search
      //Gene_id -> gene id or name, present in the tooltip
      //Desc -> Extended info, present in the tooltip
      let columnDefs = [
        {"targets": columns.indexOf('Gene_acc') , 
        "visible": false, "searchable": true},

        {"targets": columns.indexOf('Gene_id') , 
        "searchable": true },

        {"targets": columns.indexOf('Desc'), 
        "searchable": true },

      ];

      //for all the other columns, if contain a number is
      //rounded to 2nd decimal
      columns.forEach(function(d){
        if( ['Gene_acc','Gene_id','Desc'].indexOf(d) == -1 ) {
          columnDefs.push(
            {"targets": columns.indexOf(d), "searchable": false, 
            render: function(data,type,raw){return numberParser(data);}}
          );
        }
      })

      //start the datatable
      var table = $('#table').DataTable(
        {
          "dom": 'lfrtipB',
          "buttons": ['csv'],
          "search": {"regex": true},
          "lengthMenu": [[-1, 5, 10, 20, 25, 50, 100 ], 
          [ 'Show all', '5 rows', '10 rows', '20 rows', '25 rows', '50 rows', '100 rows' ]],
          "pageLength": 5,
          "scrollX": true,
          "columnDefs": columnDefs,
          //https://stackoverflow.com/questions/38575079/
          'createdRow': function(nRow, aData, iDataIndex) {
            //console.log('aData',aData);
            $(nRow).attr('id', 'row_' + aData[0]); // or if you prefer 'row' + aData.aid + aData.bid
          }
          
        }
      );
      

      $(function() {

        //sanitaize string
        //https://stackoverflow.com/questions/4562756/replacing-tab-characters-in-javascript
        function removeNewlines(str) {
          //remove line breaks from str
          str = str.replace(/\s{2,}/g, ' ');
          str = str.replace(/\t/g, ' ');
          str = str.toString().trim().replace(/(\r\n|\n|\r)/g," ");
          return str
        }


        $('#my-form').on("submit", function(e) {
          e.preventDefault(); // cancel the actual submit and page reload
          /* do what you want with the form */
          
          // Should be triggered on form submit
          //console.log('hi');
          var content = document.getElementById("textAreaIDs").value;
          content =  removeNewlines(content).split(" ") 
          console.log( content  );

          //select all the rows with the submitted protein ids
          var selectedRows = table.rows( function ( idx, data, node ) {
            //console.log('data[1]',data[1]);
            //console.log('content.indexOf(data[1])',content.indexOf(data[1]))
            return content.indexOf(data[1]) > -1 ? true : false;
          } ).data();
          console.log(selectedRows);

          //select the unique protein ids for each rro
          var selectedIDs = [];
          for (i = 0; i < selectedRows.length; i++){selectedIDs.push(selectedRows[i][0])}
          console.log(selectedIDs);
          
          //serch the ids in the table
          table.columns(0).search(selectedIDs.join('|'), true, false).draw();

          for (i = 0; i < selectedIDs.length; i++){
            d3.selectAll("circle[id*='" + selectedIDs[i] + "']")
                .style("stroke", 'red')
                .style("opacity", 1)
                .attr("stroke-width", '5')
                .raise();
          }
          
        });


        });


      $('#my-form').on("reset", function(e) {
          //e.preventDefault();
          console.log('reset');
          d3.selectAll("circle")
                .style("stroke", '')
                .style("opacity", 0.5)
                .attr("stroke-width", '');
          table.search('').columns().search('').draw();
        
        });  


      //add the plots
      scaterPlot(files[0], "plot1", 500, 350, "plot_a", X1, Y1, table, false);
      scaterPlot(files[0], "plot2", 500, 350, "plot_b", X2, Y2, table, false);
      
      //add the listner to the table rows
      $('#table tbody').on('mouseover', 'tr', function () {
        //console.log('mouseover');
        var data = table.row( this ).data();
        //console.log('data[0]', data);
        var gene_acc = data[0]
        
        var selector = '#'+gene_acc;
        //console.log('selector', selector);
        d3.selectAll(selector).style("stroke",'red').attr("stroke-width",'5').style("opacity", 1).raise();
        //console.log(d3.select(selector));
        //var id = table.row( this ).id();
        //console.log('row id',id);

      });

      $('#table tbody').on('mouseout', 'tr', function () {
        //console.log('mouseout');
        var data = table.row( this ).data();
        var gene_acc = data[0]
        var selector = '#'+gene_acc;
        d3.selectAll(selector).style("stroke",'').attr("stroke-width",'').style("opacity", 0.5);
        //console.log('data[0]', data);
        //table.search('').columns().search('').draw();
      });




    });
    $( document ).ready(function() {



      localStorage.removeItem('tour_current_step');
      localStorage.removeItem('tour_end');
      // Initialize the tour
      tour.init();
  
      // Start the tour
      tour.start();
    });



  </script>
</body>
</html>